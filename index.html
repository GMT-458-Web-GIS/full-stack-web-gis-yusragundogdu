<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudentRadar</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- TEMEL AYARLAR --- */
        body { margin: 0; font-family: 'Inter', sans-serif; display: flex; flex-direction: column; height: 100vh; background: #050505; color: #e0e0e0; overflow: hidden; }
        
        /* --- 1. TOP NAVBAR (YENƒ∞ EKLENDƒ∞) --- */
        #navbar {
            height: 70px;
            background: #0a0a0a;
            border-bottom: 1px solid #222;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            z-index: 20;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .nav-logo { font-size: 24px; font-weight: 900; color: #fff; display: flex; align-items: center; gap: 10px; }
        .nav-logo span { color: #ff9800; }
        
        .nav-links { display: flex; gap: 30px; }
        .nav-link { color: #888; text-decoration: none; font-weight: 600; font-size: 14px; transition: 0.2s; cursor: pointer; }
        .nav-link:hover { color: #fff; }
        .nav-link.active { color: #ff9800; }

        /* --- 2. ANA ƒ∞√áERƒ∞K D√úZENƒ∞ (NAVBAR ALTINDA KALAN KISIM) --- */
        #main-container {
            display: flex;
            height: calc(100vh - 70px); /* Navbar y√ºksekliƒüini d√º≈ü√ºyoruz */
            width: 100%;
            overflow: hidden;
        }

        /* SIDEBAR */
        #sidebar { 
            width: 440px; 
            background: #121212; 
            padding: 30px; 
            box-shadow: 5px 0 30px rgba(0,0,0,0.6); 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; /* Ekrana yay */
            z-index: 10; 
            border-right: 1px solid #222; 
            overflow: hidden; 
        }
        
        /* HEADER SECTION */
        .brand-title { font-size: 36px; font-weight: 900; color: #ff9800; margin-bottom: 2px; letter-spacing: -1px; line-height: 1; }
        .brand-subtitle { font-size: 12px; color: #666; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; font-weight: 700; }
        
        .intro-text { font-size: 13px; color: #aaa; line-height: 1.4; margin-bottom: 15px; border-left: 3px solid #333; padding-left: 15px; font-weight: 500; }
        .intro-text strong { color: #fff; font-weight: 700; }
        .intro-highlight { color: #ff9800; }

        /* STATS CARDS */
        .stats-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px; }
        .stat-card { background: #1a1a1a; padding: 18px; border-radius: 12px; border: 1px solid #333; display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s; }
        .stat-card:hover { transform: scale(1.02); border-color: #444; }
        .stat-card.orange { border-left: 6px solid #ff9800; } .stat-card.green { border-left: 6px solid #4caf50; } .stat-card.blue { border-left: 6px solid #2196F3; }
        .stat-info h4 { margin: 0 0 4px 0; font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .stat-info span { font-size: 28px; font-weight: 800; color: #fff; letter-spacing: -0.5px; }

        /* HARƒ∞TA */
        #map { flex-grow: 1; height: 100%; background: #050505; }

        /* BUTONLAR */
        .action-btn { width: 100%; padding: 18px; background: #222; border: 1px solid #333; color: white; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; font-size: 14px; letter-spacing: 0.5px; }
        .action-btn:hover { background: #333; border-color: #555; color: #ff9800; }

        #auth-panel { padding-top: 10px; border-top: 1px solid #222; margin-top: auto; }
        .main-btn { width: 100%; padding: 16px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; font-size: 13px; margin-bottom: 0; transition: 0.2s; } 
        .btn-login { background: #ff9800; color: black; } .btn-login:hover { background: #ffad33; }
        .btn-logout { background: #d32f2f; color: white; display: none; } .btn-logout:hover { background: #ef5350; }

        /* MODALS GENEL */
        #cities-modal, #city-detail-panel, #new-data-modal, #login-modal, #faq-modal, #contact-modal { display: none; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); z-index: 7000; align-items: center; justify-content: center; display: none; }
        
        /* FAQ & CONTACT MODAL STƒ∞Lƒ∞ */
        .info-modal { background: #181818; width: 700px; max-height: 85vh; border-radius: 20px; border: 1px solid #333; overflow-y: auto; padding: 0; box-shadow: 0 50px 100px rgba(0,0,0,0.9); }
        .info-header { padding: 30px; border-bottom: 1px solid #2a2a2a; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #181818; }
        .info-title { font-size: 24px; font-weight: 800; color: white; }
        .info-close { cursor: pointer; font-size: 24px; color: #666; } .info-close:hover { color: white; }
        .info-body { padding: 40px; color: #ccc; line-height: 1.7; font-size: 15px; }
        .info-body h3 { color: #ff9800; font-size: 18px; margin-bottom: 10px; margin-top: 30px; }
        .info-body h3:first-child { margin-top: 0; }
        .info-body p { margin-bottom: 15px; }
        .info-body ul { margin-bottom: 15px; padding-left: 20px; }
        .info-body li { margin-bottom: 8px; }

        /* CITIES LIST MODAL */
        #cities-modal { position: fixed; inset: 0; background: #080808; z-index: 6000; flex-direction: column; padding: 60px; overflow-y: auto; }
        .cm-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 50px; max-width: 1400px; width: 100%; margin: 0 auto; }
        .cm-title { font-size: 48px; font-weight: 900; color: white; letter-spacing: -1px; }
        .cm-search { width: 100%; max-width: 600px; padding: 25px; background: #1a1a1a; border: 1px solid #333; border-radius: 12px; color: white; font-size: 20px; outline: none; font-weight: 600; } .cm-search:focus { border-color: #ff9800; }
        .cm-close { cursor: pointer; color: #888; font-size: 40px; transition: 0.2s; } .cm-close:hover { color: white; transform: rotate(90deg); }
        .cities-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; max-width: 1400px; width: 100%; margin: 0 auto; }
        .city-box { background: #151515; border: 1px solid #222; border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 140px; }
        .city-box:hover { background: #1a1a1a; border-color: #ff9800; transform: translateY(-8px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .city-box h3 { margin: 0; font-size: 20px; color: #ddd; font-weight: 800; }
        .city-box span { font-size: 14px; color: #555; margin-top: 8px; font-weight: 600; }
        .city-box.active-city { border-color: #ff9800; background: linear-gradient(135deg, #1a1500, #000); } .city-box.active-city h3 { color: #ff9800; }

        /* DETAIL PANEL */
        #city-detail-panel { position: fixed; inset: 0; background: #050505; z-index: 5000; overflow-y: auto; padding: 80px; }
        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid #333; padding-bottom: 30px; }
        .detail-title { font-size: 72px; font-weight: 900; color: white; margin: 0; letter-spacing: -3px; line-height: 1; }
        .close-btn { background: #222; color: white; border: 1px solid #444; padding: 18px 40px; border-radius: 50px; cursor: pointer; font-weight: 800; font-size: 15px; transition: 0.2s; letter-spacing: 1px; } 
        .close-btn:hover { background: #ff9800; color: black; border-color: #ff9800; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 35px; margin-bottom: 60px; }
        .detail-card { background: #121212; border: 1px solid #222; border-radius: 24px; padding: 40px; display: flex; flex-direction: column; justify-content: space-between; height: 260px; position: relative; transition: transform 0.2s; }
        .detail-card:hover { transform: translateY(-8px); border-color: #444; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .dc-icon { font-size: 36px; margin-bottom: 15px; } .dc-label { font-size: 15px; color: #888; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; } .dc-value { font-size: 48px; font-weight: 900; color: #ff9800; margin-top: 10px; margin-bottom: 10px; letter-spacing: -1px; }
        .card-add-btn { display: none; margin-top: auto; width: 100%; padding: 18px; background: transparent; border: 1px dashed #444; color: #888; font-size: 15px; font-weight: 700; border-radius: 12px; cursor: pointer; transition: 0.2s; } .card-add-btn:hover { background: #1a1a1a; border-color: #ff9800; color: #ff9800; }

        /* UNI LIST */
        .uni-section { border-top: 1px solid #222; padding-top: 50px; margin-bottom: 50px; }
        .uni-title { font-size: 36px; font-weight: 800; color: white; margin-bottom: 30px; display: flex; align-items: center; gap: 15px; }
        .uni-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
        .uni-card { background: #121212; padding: 30px; border-radius: 16px; border: 1px solid #2a2a2a; display: flex; align-items: center; gap: 25px; transition: 0.2s; }
        .uni-card:hover { border-color: #444; background: #181818; transform: translateX(5px); }
        .uni-rank { font-size: 28px; font-weight: 900; color: #444; width: 40px; text-align: center; }
        .uni-rank.top-1 { color: #FFD700; } .uni-rank.top-2 { color: #C0C0C0; } .uni-rank.top-3 { color: #CD7F32; }
        .uni-name { font-size: 20px; font-weight: 700; color: #e0e0e0; }
        .uni-type { font-size: 13px; color: #666; font-weight: 700; text-transform: uppercase; margin-left: auto; background: #080808; padding: 8px 15px; border-radius: 8px; }

        /* LOGIN & DATA MODALS */
        .modern-modal { background: #181818; width: 500px; border-radius: 24px; border: 1px solid #333; box-shadow: 0 50px 100px rgba(0,0,0,0.9); overflow: hidden; font-family: 'Inter', sans-serif; }
        .mm-header { padding: 30px 40px; border-bottom: 1px solid #2a2a2a; display: flex; justify-content: space-between; align-items: center; }
        .mm-title h3 { margin: 0; font-size: 22px; color: white; font-weight: 800; } .mm-close { cursor: pointer; color: #666; font-size: 30px; } .mm-close:hover { color: white; }
        .mm-body { padding: 40px; }
        .mm-stat-box { background: #202020; border-radius: 16px; padding: 30px; margin-bottom: 30px; } 
        .mm-stat-label { font-size: 15px; color: #888; margin-bottom: 10px; font-weight: 600; } .mm-stat-value { font-size: 40px; font-weight: 900; color: #ff9800; }
        .mm-input { width: 100%; background: #2a2a2a; border: 1px solid #333; padding: 22px; border-radius: 14px; color: white; font-size: 22px; box-sizing: border-box; outline: none; margin-bottom: 30px; font-weight: 700; } .mm-input:focus { border-color: #666; background: #333; }
        .mm-btn { width: 100%; background: #3a3a3a; color: white; padding: 22px; border: 1px solid #444; border-radius: 14px; font-weight: 800; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 16px; letter-spacing: 0.5px; transition: 0.2s; } .mm-btn:hover { background: #eee; color: #000; border-color: #fff; }

        .simple-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #181818; padding: 60px; border-radius: 24px; border: 1px solid #333; width: 420px; z-index: 8000; text-align: center; box-shadow: 0 50px 100px rgba(0,0,0,0.9); }
        .simple-modal input { width: 100%; padding: 20px; margin-bottom: 20px; background: #222; border: 1px solid #333; color: white; border-radius: 12px; box-sizing: border-box; font-size: 16px; font-weight: 600; }
        .simple-modal button { width: 100%; padding: 20px; background: #ff9800; border: none; font-weight: 900; border-radius: 12px; cursor: pointer; color: black; font-size: 16px; letter-spacing: 1px; transition: 0.2s; }
        .secondary-btn { width: 100%; padding: 15px; background: transparent; border: 1px solid #444; color: #888; border-radius: 12px; cursor: pointer; margin-top: 20px; font-size: 14px; font-weight: 700; } .secondary-btn:hover { border-color: #666; color: white; background: #222; }

        #toast { visibility: hidden; min-width: 350px; background-color: #1a1a1a; color: #fff; text-align: center; border-radius: 12px; padding: 25px; position: fixed; z-index: 9000; left: 50%; bottom: 50px; transform: translateX(-50%); border-left: 8px solid #ff9800; box-shadow: 0 20px 50px rgba(0,0,0,0.9); font-size: 18px; font-weight: 700; }
        #tooltip { position: absolute; background: rgba(10,10,10,0.95); border: 1px solid #ff9800; border-radius:8px; padding:15px; color:white; display:none; z-index:1000; pointer-events:none; font-family: 'Inter', sans-serif; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <nav id="navbar">
        <div class="nav-logo">
            <span style="font-size:20px;">üçä</span> Student<span>Radar</span>
        </div>
        <div class="nav-links">
            <div class="nav-link active">Map</div>
            <div class="nav-link" onclick="openCitiesModal()">All Cities</div>
            <div class="nav-link" onclick="openModal('faq-modal')">FAQ</div>
            <div class="nav-link" onclick="openModal('contact-modal')">Contact</div>
        </div>
    </nav>

    <div id="main-container">
        <div id="sidebar">
            <div class="header-section">
                <div class="brand-title">StudentRadar</div>
                <div class="brand-subtitle">National Living Cost Index</div>
                
                <div class="intro-text">
                    <strong>Turkey's Ultimate Student Guide üáπüá∑</strong><br>
                    View average <strong>rent, abonman fees, and expenses</strong>.<br>
                    Discover the <strong class="intro-highlight">Top 5 Universities</strong> in 81 provinces.
                </div>
            </div>
            
            <div class="stats-container">
                <div class="stat-card orange"><div class="stat-info"><h4>Avg. Rent (TR)</h4><span id="global-rent">...</span></div></div>
                <div class="stat-card green"><div class="stat-info"><h4>Avg. Coffee</h4><span id="global-coffee">...</span></div></div>
                <div class="stat-card blue"><div class="stat-info"><h4>Avg. Abonman</h4><span id="global-trans">...</span></div></div>
            </div>
            
            <button class="action-btn" onclick="openCitiesModal()">
                <span style="font-size:20px;">üèôÔ∏è</span> VIEW ALL 81 CITIES
            </button>

            <div id="auth-panel">
                <p id="user-status" style="font-size: 12px; color: #666; text-align: center; margin-bottom: 10px; font-weight: 700; letter-spacing: 1px;">GUEST VIEW</p>
                <button class="main-btn btn-login" onclick="document.getElementById('login-modal').style.display='block'">Login to Contribute</button>
                <button class="main-btn btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <div id="tooltip"></div>

    <div id="cities-modal">
        <div class="cm-header">
            <h2 class="cm-title">Explore All Cities</h2>
            <input type="text" id="city-search-input" class="cm-search" placeholder="Search for a city..." onkeyup="searchCities()">
            <div class="cm-close" onclick="document.getElementById('cities-modal').style.display='none'">‚úï</div>
        </div>
        <div class="cities-grid" id="cities-grid-container"></div>
    </div>

    <div id="faq-modal" class="modal-overlay">
        <div class="info-modal">
            <div class="info-header">
                <div class="info-title">Frequently Asked Questions</div>
                <div class="info-close" onclick="closeModal('faq-modal')">‚úï</div>
            </div>
            <div class="info-body">
                <h3>Where does the data come from?</h3>
                <p>All data on StudentRadar is entered anonymously by students like you. This is known as <strong>User-Generated Content (UGC)</strong>, similar to Wikipedia.</p>

                <h3>How accurate is the data?</h3>
                <p>We rely on the <strong>Law of Large Numbers</strong>. As more people contribute, outliers are filtered out automatically, leaving accurate averages.</p>

                <h3>How to use?</h3>
                <ul>
                    <li><strong>Select a City:</strong> Click on the map or use the search bar.</li>
                    <li><strong>Contribute:</strong> Login and click on a category (Rent, Coffee, etc.) to add your own data.</li>
                    <li><strong>Compare:</strong> See how your expenses compare to the city average.</li>
                </ul>

                <h3>Data Privacy</h3>
                <p>Your privacy is our priority. We <strong>do not store</strong> names, emails, phone numbers, or IP addresses. Only the anonymous cost data is saved.</p>
            </div>
        </div>
    </div>

    <div id="contact-modal" class="modal-overlay">
        <div class="info-modal" style="width: 400px; height: auto;">
            <div class="info-header">
                <div class="info-title">Contact Us</div>
                <div class="info-close" onclick="closeModal('contact-modal')">‚úï</div>
            </div>
            <div class="info-body" style="text-align: center; padding: 50px 20px;">
                <p style="font-size: 16px; color: #888;">For any questions or feedback:</p>
                <h3 style="font-size: 24px; color: #ff9800; margin-top: 10px;">ysragndodu@gmail.com</h3>
            </div>
        </div>
    </div>

    <div id="city-detail-panel">
        <div class="detail-header">
            <h1 class="detail-title" id="dp-city-name">City</h1>
            <button class="close-btn" onclick="document.getElementById('city-detail-panel').style.display='none'">‚Üê BACK TO MAP</button>
        </div>
        <div class="detail-grid">
            <div class="detail-card"><div><div class="dc-icon">üí∞</div><div class="dc-label">Salary</div><div class="dc-value" id="dp-salary">‚Ç∫0</div></div><button class="card-add-btn" onclick="openAddData('Salary')">+ Contribute</button></div>
            <div class="detail-card" style="border-color:#ff9800;"><div><div class="dc-icon">üè†</div><div class="dc-label">Rent</div><div class="dc-value" id="dp-rent">‚Ç∫0</div></div><button class="card-add-btn" onclick="openAddData('Rent')">+ Contribute</button></div>
            <div class="detail-card"><div><div class="dc-icon">üõí</div><div class="dc-label">Expenses</div><div class="dc-value" id="dp-expense">‚Ç∫0</div></div><button class="card-add-btn" onclick="openAddData('Expense')">+ Contribute</button></div>
            <div class="detail-card"><div><div class="dc-icon">üöå</div><div class="dc-label">Abonman</div><div class="dc-value" id="dp-sub">‚Ç∫0</div></div><button class="card-add-btn" onclick="openAddData('Abonman')">+ Contribute</button></div>
            <div class="detail-card"><div><div class="dc-icon">‚òï</div><div class="dc-label">Coffee</div><div class="dc-value" id="dp-coffee">‚Ç∫0</div></div><button class="card-add-btn" onclick="openAddData('Coffee')">+ Contribute</button></div>
            <div class="detail-card"><div><div class="dc-icon">‚è±Ô∏è</div><div class="dc-label">Commute</div><div class="dc-value" id="dp-commute">0 min</div></div><button class="card-add-btn" onclick="openAddData('Transport')">+ Contribute</button></div>
        </div>
        <div class="uni-section"><div class="uni-title"><span>üéì</span> Top Universities</div><div class="uni-grid" id="dp-uni-list"></div></div>
    </div>

    <div id="new-data-modal" class="modal-overlay">
        <div class="modern-modal">
            <div class="mm-header"><div class="mm-title"><h3>Contribute Data</h3></div><div class="mm-close" onclick="document.getElementById('new-data-modal').style.display='none'">‚úï</div></div>
            <div class="mm-body"><div class="mm-stat-box"><div class="mm-stat-label" id="mm-category">Rent</div><div class="mm-stat-value" id="mm-current-val">...</div></div><input type="number" id="mm-input-price" class="mm-input" placeholder="Enter Value"><button class="mm-btn" onclick="submitData()">SAVE TO DATABASE</button></div>
        </div>
    </div>
    
    <div id="login-modal" class="simple-modal">
        <h2 style="color:#ff9800;">Login</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">LOGIN</button>
        <button class="secondary-btn" onclick="register()">No account? Register</button>
        <p style="color:#666; font-size:14px; margin-top:25px; cursor:pointer; font-weight:600;" onclick="document.getElementById('login-modal').style.display='none'">Close Window</p>
    </div>

    <div id="toast"><span id="toast-msg">Notification</span></div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script>
        let realMarketData = {}, currentPanelCity = "";
        
        // MODAL HELPERS
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        const cityUniversities = {
            "ƒ∞stanbul": ["Boƒüazi√ßi √úni.", "ƒ∞T√ú (Technical)", "Ko√ß √úniversitesi", "Sabancƒ± √úni.", "Yƒ±ldƒ±z Teknik √úni."],
            "Ankara": ["ODT√ú (METU)", "Bilkent √úni.", "Hacettepe √úni.", "Ankara √úni.", "Gazi √úniversitesi"],
            "ƒ∞zmir": ["ƒ∞zmir Y√ºksek Tek.", "Ege √úniversitesi", "Dokuz Eyl√ºl √úni.", "ƒ∞zmir Ekonomi", "Ya≈üar √úniversitesi"],
            "Eski≈üehir": ["Anadolu √úni.", "Eski≈üehir Osmangazi", "Eski≈üehir Teknik", "Atat√ºrk √úni.", "Havacƒ±lƒ±k YO"],
            "Bursa": ["Uludaƒü √úniversitesi", "Bursa Teknik √úni.", "Mudanya √úni.", "Faruk Sara√ß MYO", "-"],
            "Antalya": ["Akdeniz √úniversitesi", "Antalya Bilim √úni.", "Alanya Alaaddin", "Belek √úni.", "-"],
            "Konya": ["Sel√ßuk √úniversitesi", "Konya Teknik √úni.", "Necmettin Erbakan", "KTO Karatay", "Konya Gƒ±da Tarƒ±m"],
            "Trabzon": ["KT√ú (Karadeniz Tek.)", "Trabzon √úni.", "Avrasya √úni.", "-", "-"],
            "Gaziantep": ["Gaziantep √úni.", "Hasan Kalyoncu", "Sanko √úni.", "ƒ∞slam Bilim Tek.", "-"],
            "Adana": ["√áukurova √úniversitesi", "Alparslan T√ºrke≈ü", "Adana Bilim Tek.", "-", "-"]
        };

        const categoryConfig = { 'Rent': 'Rent', 'Coffee': 'Coffee', 'Abonman': 'Abonman', 'Transport': 'Travel Time', 'Salary': 'Salary', 'Expense': 'Expenses' };

        async function loadData() {
            try {
                const res = await fetch('/api/data');
                realMarketData = await res.json();
                updateMapStyles(); calculateGlobalStats(); populateCitiesGrid();
            } catch (e) { console.error(e); }
        }

        function calculateGlobalStats() {
            let tr=0, cr=0, tc=0, cc=0, ts=0, cs=0;
            Object.values(realMarketData).forEach(c => {
                let r=parseFloat(c.rent?.replace('.','')||0); if(r>0){tr+=r;cr++;}
                let cof=parseFloat(c.coffee||0); if(cof>0){tc+=cof;cc++;}
                let s=parseFloat(c.sub||0); if(s>0){ts+=s;cs++;}
            });
            document.getElementById('global-rent').innerText = cr?'‚Ç∫'+Math.round(tr/cr).toLocaleString('tr-TR'):'‚Ç∫0';
            document.getElementById('global-coffee').innerText = cc?'‚Ç∫'+(tc/cc).toFixed(2):'‚Ç∫0';
            document.getElementById('global-trans').innerText = cs?'‚Ç∫'+(ts/cs).toFixed(2):'‚Ç∫0';
        }

        const map = new ol.Map({ target: 'map', layers: [], view: new ol.View({ center: ol.proj.fromLonLat([35.2433, 39.0]), zoom: 7.1, minZoom: 5, maxZoom: 9 }) });
        const vectorSource = new ol.source.Vector({ url: './turkey.geojson', format: new ol.format.GeoJSON() });
        const vectorLayer = new ol.layer.Vector({ source: vectorSource, style: f => {
            const name = f.get('name')||f.get('Name');
            const d = realMarketData[name];
            const isActive = d && (parseFloat(d.rent?.replace('.','')||0) > 0 || parseFloat(d.coffee||0) > 0);
            return new ol.style.Style({ 
                fill: new ol.style.Fill({ color: isActive ? 'rgba(255, 152, 0, 0.9)' : 'rgba(40, 40, 40, 1)' }), 
                stroke: new ol.style.Stroke({ color: '#111', width: 1 }), 
                text: new ol.style.Text({ text: name, font: '10px Inter', fill: new ol.style.Fill({ color: isActive?'#000':'#666' }), stroke: new ol.style.Stroke({ color: isActive?'rgba(255,255,255,0.8)':'#000', width: 2 }) }) 
            });
        }});
        map.addLayer(vectorLayer);
        function updateMapStyles() { vectorLayer.changed(); }
        map.on('click', e => { const f = map.forEachFeatureAtPixel(e.pixel, i=>i); if(f) openCityPanel(f.get('name')||f.get('Name')); });

        function openCityPanel(n) {
            currentPanelCity=n;
            const d = realMarketData[n] || {rent:'0', coffee:'0', sub:'-', salary:'0', expense:'0', commute:'0'};
            
            document.getElementById('dp-city-name').innerText = n;
            document.getElementById('dp-rent').innerText = '‚Ç∫'+d.rent;
            document.getElementById('dp-coffee').innerText = '‚Ç∫'+d.coffee;
            document.getElementById('dp-sub').innerText = d.sub==='-'?'N/A':'‚Ç∫'+d.sub;
            document.getElementById('dp-salary').innerText = '‚Ç∫'+d.salary;
            document.getElementById('dp-expense').innerText = '‚Ç∫'+d.expense;
            document.getElementById('dp-commute').innerText = d.commute;

            const uniList = document.getElementById('dp-uni-list');
            uniList.innerHTML = ""; 
            const unis = cityUniversities[n] || [`${n} √úniversitesi`, `${n} Teknik √úni.`, `${n} Bilim √úniversitesi`];
            unis.forEach((uni, index) => {
                if(uni === "-") return;
                let rankClass = ""; if(index === 0) rankClass = "top-1"; else if(index === 1) rankClass = "top-2"; else if(index === 2) rankClass = "top-3";
                const div = document.createElement('div');
                div.className = 'uni-card';
                div.innerHTML = `<div class="uni-rank ${rankClass}">#${index + 1}</div><div class="uni-name">${uni}</div><div class="uni-type">${index === 0 ? 'State' : 'University'}</div>`;
                uniList.appendChild(div);
            });

            const loggedIn = localStorage.getItem('token');
            document.querySelectorAll('.card-add-btn').forEach(b => b.style.display=loggedIn?'block':'none');
            document.getElementById('city-detail-panel').style.display='block';
        }

        function openCitiesModal() { document.getElementById('cities-modal').style.display = 'flex'; populateCitiesGrid(); }

        function populateCitiesGrid() {
            const c = document.getElementById('cities-grid-container'); c.innerHTML="";
            const f = vectorSource.getFeatures().sort((a,b)=>(a.get('name')||'').localeCompare(b.get('name')||''));
            f.forEach(ft => {
                const n = ft.get('name')||ft.get('Name');
                const d = realMarketData[n];
                const active = d && (parseFloat(d.rent?.replace('.','')||0)>0);
                const div = document.createElement('div');
                div.className=`city-box ${active?'active-city':''}`;
                div.innerHTML=`<h3>${n}</h3><span>${active?'Active':'No Data'}</span>`;
                div.onclick=()=>{ document.getElementById('cities-modal').style.display='none'; openCityPanel(n); };
                c.appendChild(div);
            });
        }

        function searchCities() {
            const v = document.getElementById('city-search-input').value.toLowerCase();
            Array.from(document.getElementsByClassName('city-box')).forEach(b => b.style.display=b.innerText.toLowerCase().includes(v)?'flex':'none');
        }

        function openAddData(cat) {
            document.getElementById('mm-category').innerText = categoryConfig[cat];
            document.getElementById('mm-input-price').dataset.cat = cat;
            document.getElementById('mm-input-price').value = "";
            document.getElementById('new-data-modal').style.display='flex';
            const d = realMarketData[currentPanelCity] || {};
            let val = "0"; if(cat==='Rent') val=d.rent; else if(cat==='Coffee') val=d.coffee; 
            document.getElementById('mm-current-val').innerText = 'Current: ' + (val||'0');
        }

        async function submitData() {
            const val = document.getElementById('mm-input-price').value;
            const cat = document.getElementById('mm-input-price').dataset.cat;
            const token = localStorage.getItem('token');
            if(!val) return showToast("Enter value");
            
            const res = await fetch('/api/update', {
                method: 'POST', headers: {'Content-Type':'application/json', 'Authorization':'Bearer '+token},
                body: JSON.stringify({city: currentPanelCity, category: cat, value: val})
            });
            if(res.ok) { showToast("Saved Successfully!"); document.getElementById('new-data-modal').style.display='none'; await loadData(); openCityPanel(currentPanelCity); } 
            else showToast("Error Saving");
        }

        async function login() {
            const u=document.getElementById('username').value, p=document.getElementById('password').value;
            const res = await fetch('/api/auth/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p})});
            const d = await res.json();
            if(res.ok) { localStorage.setItem('token', d.token); localStorage.setItem('user', d.username); updateAuthUI(); document.getElementById('login-modal').style.display='none'; showToast("Logged In"); } 
            else showToast("Login Failed");
        }
        async function register() {
            const u=document.getElementById('username').value, p=document.getElementById('password').value;
            const res = await fetch('/api/auth/register', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p})});
            if(res.ok) { showToast("Account Created! Please Login."); } else showToast("Register Failed");
        }
        function logout() { localStorage.clear(); updateAuthUI(); }

        function updateAuthUI() {
            const user = localStorage.getItem('user');
            if(user) {
                document.getElementById('user-status').innerText = "LOGGED IN: " + user.toUpperCase();
                document.querySelector('.btn-login').style.display='none';
                document.querySelector('.btn-logout').style.display='block';
                document.querySelectorAll('.card-add-btn').forEach(b => b.style.display='block');
            } else {
                document.getElementById('user-status').innerText = "GUEST VIEW";
                document.querySelector('.btn-login').style.display='block';
                document.querySelector('.btn-logout').style.display='none';
                document.querySelectorAll('.card-add-btn').forEach(b => b.style.display='none');
            }
        }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.visibility='visible'; setTimeout(()=>t.style.visibility='hidden',3000); }

        loadData(); updateAuthUI();
    </script>
</body>
</html>